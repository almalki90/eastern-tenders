name: ğŸ¤– ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ§Øª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ

on:
  # ØªØ´ØºÙŠÙ„ ÙƒÙ„ 12 Ø³Ø§Ø¹Ø©
  schedule:
    - cron: '0 */12 * * *'  # At minute 0 past every 12th hour
  
  # ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠ
  workflow_dispatch:
  
  # ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ Push
  push:
    branches: [ main ]

jobs:
  scrape-and-deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          npm install
          npx playwright install chromium
          npx playwright install-deps
      
      - name: ğŸ•·ï¸ Scrape Tenders Data
        run: |
          echo "ğŸš€ Ø¨Ø¯Ø¡ Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª..."
          npm run scrape
          echo "âœ… ØªÙ… Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­"
      
      - name: ğŸ“¡ Generate RSS Feed
        run: |
          echo "ğŸ“¡ ØªÙˆÙ„ÙŠØ¯ RSS Feed..."
          npm run generate-rss
          echo "âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ RSS Ø¨Ù†Ø¬Ø§Ø­"
      
      - name: ğŸ“Š Display Stats
        run: |
          echo "ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:"
          if [ -f data/tenders.json ]; then
            COUNT=$(cat data/tenders.json | grep -o '"id"' | wc -l)
            echo "Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ§Øª: $COUNT"
          fi
      
      - name: ğŸ’¾ Commit Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add data/ public/
          
          if git diff --staged --quiet; then
            echo "âœ¨ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©"
          else
            TIMESTAMP=$(TZ='Asia/Riyadh' date '+%Y-%m-%d %H:%M:%S')
            git commit -m "ğŸ¤– ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª - $TIMESTAMP"
            git push
            echo "âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­"
          fi
      
      - name: ğŸ“¤ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'ğŸš€ Ù†Ø´Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª - ${{ github.event.head_commit.message }}'
      
      - name: âœ… Success Notification
        run: |
          echo "âœ¨ =================================="
          echo "âœ… ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!"
          echo "ğŸ“Š Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ø¯Ø«Ø©"
          echo "ğŸ“¡ RSS Feed Ø¬Ø§Ù‡Ø²"
          echo "ğŸŒ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù†Ø´ÙˆØ±"
          echo "=================================="
